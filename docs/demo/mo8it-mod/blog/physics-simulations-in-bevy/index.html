<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <title>Physics Simulations in Bevy</title>

        <meta name="description"
              content="Sharing my experience using Bevy for physics simulations from scratch">

        <link rel="icon"
              type="image/x-icon"
              href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/images/logo.svg?v=1735302140">

        <link href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/main.css?v=1735302140"
              rel="stylesheet">

        <link rel="alternate"
              type="application/atom+xml"
              title="Blog | mo8it.com"
              href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/atom.xml">

        <meta property="og:title" content="Physics Simulations in Bevy">
        <meta property="og:description" content="Sharing my experience using Bevy for physics simulations from scratch">
        <meta property="og:image"
              content="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/images/logo.svg?v=1735302140">
        <meta property="og:url" content="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/blog/physics-simulations-in-bevy/">
    </head>

    <body class="flex flex-col p-3 mx-auto min-h-screen text-lg text-gray-100 break-words bg-gray-900 lg:px-5 2xl:container">
        <header class="flex gap-x-6 items-center py-2 px-2.5 mb-1 bg-gray-800 rounded-full">
            <a class="transition duration-500 hover:scale-110"
               href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod"
               aria-hidden="true">
                <img class="m-0 w-12 h-12 rounded-full"
                     src="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/images/logo.svg"
                     alt="">
            </a>

            <nav class="flex gap-x-5 items-center font-bold">
                
                    <a class="p-1 no-underline" href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/">Home</a>
                
                    <a class="p-1 no-underline" href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/blog">Blog</a>
                
                    <a class="p-1 no-underline" href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/tags">Tags</a>
                
            </nav>
        </header>

        <main class="leading-relaxed">
            
    <article>
        <div class="mb-3">
            <h1>Physics Simulations in Bevy</h1>

            
    <div class="mt-2 mb-4 text-sm leading-normal text-gray-300">
        <time datetime="2024-07-19">2024-07-19</time><p class="my-0">
            Tags:
            <a href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/tags/rust">#rust</a></p>

        <p class="my-0">Reading time: ~9min</p>

        <hr class="my-2.5">
    </div>

        </div>

        <p><a href="https://bevyengine.org/">Bevy</a> is the most popular and powerful game engine in Rust.
Because of its flexibility, it can be used not only for games but also for (scientific) physics simulations.</p>
<p>In this blog post, I will share my experience using Bevy for physics simulations from scratch as part of my master's thesis supervised by <a href="https://www.staff.uni-mainz.de/schoemer/">Prof. Elmar Sch√∂mer</a>.</p>
<div class="rounded-xl bg-sky-400/20">
    <div class="px-2 pt-2 pb-1 my-3 text-white">
        <p class="font-bold">Note</p>
        <p>This blog post is the base for my talk at <a href="https://scientificcomputing.rs">Scientific Computing in Rust 2024</a>.
You can watch the <a href="https://youtu.be/Ys8y6aozo6g">recorded talk on YouTube</a> ‚èØÔ∏è</p>

    </div>
</div>
<span id="continue-reading"></span>
    <p class="p-1 my-4 text-base rounded sm:hidden bg-yellow-200/20">Landscape mode recommended on mobile devices</p>

    
        <div class="px-4 pt-3 pb-0.5 mt-3 mb-1 bg-gray-800 rounded">
            <p class="text-2xl font-bold">Contents</p>

            <nav>
                <ul class="ml-0 list-none">
                    
                        
                            <li><a href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/blog/physics-simulations-in-bevy/#learning-resources">Learning Resources</a></li>
                        
                    
                        
                            <li><a href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/blog/physics-simulations-in-bevy/#solver">Solver</a></li>
                        
                    
                        
                            <li><a href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/blog/physics-simulations-in-bevy/#debugging">Debugging</a></li>
                        
                    
                        
                            <li><a href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/blog/physics-simulations-in-bevy/#ecosystem">Ecosystem</a></li>
                        
                    
                        
                            <li><a href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/blog/physics-simulations-in-bevy/#ecs">ECS</a></li>
                        
                    
                        
                            <li><a href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/blog/physics-simulations-in-bevy/#simulations">Simulations</a></li>
                        
                    
                        
                            <li><a href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/blog/physics-simulations-in-bevy/#migrations">Migrations</a></li>
                        
                    
                        
                            <li><a href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/blog/physics-simulations-in-bevy/#conclusion">Conclusion</a></li>
                        
                    
                </ul>
            </nav>
        </div>
    

<h2 id="learning-resources"><a class="text-white no-underline transition-none hover:underline"
   href="#learning-resources">Learning Resources</a></h2>
<p>In this section, I will talk about the resources that helped me get into Bevy.</p>
<p>Bevy offers an official <a href="https://bevyengine.org/learn/quick-start/introduction/">Quick Start Guide</a> that gets you started with a simple program and briefly explains the most important concepts in Bevy.
But it is too short!
At its end, you get to the <a href="https://bevyengine.org/learn/quick-start/next-steps/">Next Steps</a> page which shows you some links.
In my opinion, the most important link is the one to the unofficial <a href="https://bevy-cheatbook.github.io/">Bevy Cheat Book</a> by <a href="https://github.com/inodentry">Ida (@inodentry)</a>.
This cheat book is very helpful; the missing piece of high level documentation üìöÔ∏è</p>
<p>After getting familiar with the basics, you can check out the official <a href="https://github.com/bevyengine/bevy/tree/latest/examples#examples">examples</a>.
They are well documented and you can even <a href="https://bevyengine.org/examples/">run them in your browser</a>.</p>
<p>Of course, there is also the API documentation on <a href="https://docs.rs/bevy">docs.rs/bevy</a>.</p>
<p>There are some good tutorials on YouTube.
<a href="https://www.youtube.com/@chrisbiscardi">Chris Biscardi</a> has some wonderful videos about Bevy.
He also offers <a href="https://thisweekinbevy.com">This Week in Bevy</a>, a weekly overview of what is new in Bevy and its ecosystem.
<a href="https://www.youtube.com/@ZymartuGames">Zymartu Games</a> also has some helpful videos for beginners.</p>
<p>Because Bevy is still under heavy development, third-party learning resources get partially outdated after some releases.
This might not be a huge deal for people using Bevy long enough to know how to adapt to the latest version.
But it is a problem for beginners who just want to follow a tutorial without checking the migration guides of the latest versions.</p>
<p>It is only a matter of time until Bevy gets more stable and the set of learning resources improves.
Until then, use the resources I mentioned and don't hesitate to ask the Bevy community when you need help.
The community is lovely ü§ó</p>
<h2 id="solver"><a class="text-white no-underline transition-none hover:underline"
   href="#solver">Solver</a></h2>
<p>Although there are physics engines for Bevy, I implemented the solver from scratch to get a deeper understanding of how it works.
Using a "black box" isn't the goal of my thesis.</p>
<p>The solver that I implemented is based on <a href="https://matthias-research.github.io/pages/publications/PBDBodies.pdf">this paper</a> about Extended Position Based Dynamics (XPBD) for rigid bodies.</p>
<p>Luckily, I found these <a href="https://johanhelsing.studio/posts/bevy-xpbd/">XPBD tutorials in Rust</a> by Johan Helsing.
Although they aren't done yet, they are very well written and I highly recommend following them if you are interested in implementing physics from scratch in Bevy.
They helped me with the initial code design and were the perfect step-by-step guide to get started with XPBD.</p>
<p>My general tip for implementing physics from scratch is to start simple and gradually increase the complexity.
A good first step is to simulate a sphere bouncing on the ground without friction.
Plot the energy over time and make sure that the total energy is conserved (slow decay is normal due to numerical errors).
Then, move on to a box bouncing on the ground to also consider rotation.
Don't make my mistake of trying to implement the whole simulation method at once and directly trying to simulate the interaction between two complex objects üòÖ</p>
<h2 id="debugging"><a class="text-white no-underline transition-none hover:underline"
   href="#debugging">Debugging</a></h2>
<p>At some point, I was stuck on a bug with the implementation of friction.
Trust me, debugging floats isn't fun!
<a href="https://bevyengine.org/examples/gizmos/3d-gizmos/">Gizmos</a> are essential for visual debugging.
I highly recommend adding them to the debug builds of your games or simulations.</p>
<p>Another very helpful tool for visual debugging is <a href="https://bevyengine.org/news/bevy-0-13/#system-stepping">system stepping</a>.
It is a rather new feature in Bevy that was introduced in version <code>0.13</code>.
It allows you to control the execution of some <em>systems</em> (e.g. physics logic) at runtime.</p>
<p>Take a look at this function that I use to handle stepping:</p>
<pre data-lang="rust" style="background-color:#212733;color:#ccc9c2;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="font-style:italic;color:#5c6773;">// Ignore the signature if you aren&#39;t familiar with Bevy.
</span><span style="color:#ffa759;">fn </span><span style="color:#ffd580;">stepping_handler</span><span>(</span><span style="color:#ffa759;">mut </span><span style="color:#ffcc66;">stepping</span><span style="color:#ccc9c2cc;">: </span><span>ResMut&lt;Stepping&gt;, </span><span style="color:#ffcc66;">input</span><span style="color:#ccc9c2cc;">: </span><span>Res&lt;ButtonInput&lt;KeyCode&gt;&gt;) {
</span><span>    </span><span style="color:#ffa759;">if</span><span> input</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">just_pressed</span><span>(KeyCode</span><span style="color:#f29e74;">::</span><span>Digit1) </span><span style="color:#f29e74;">||</span><span> input</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">pressed</span><span>(KeyCode</span><span style="color:#f29e74;">::</span><span>Digit2) {
</span><span>        </span><span style="font-style:italic;color:#5c6773;">// Pressing 1 runs the systems for one frame.
</span><span>        </span><span style="font-style:italic;color:#5c6773;">// Holding 2 runs the systems until the key is released.
</span><span>        stepping</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">continue_frame</span><span>()</span><span style="color:#ccc9c2cc;">;
</span><span>    } </span><span style="color:#ffa759;">else if</span><span> input</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">just_pressed</span><span>(KeyCode</span><span style="color:#f29e74;">::</span><span>Digit3) {
</span><span>        </span><span style="font-style:italic;color:#5c6773;">// Pressing 3 disables stepping which means that the systems run freely.
</span><span>        stepping</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">disable</span><span>()</span><span style="color:#ccc9c2cc;">;
</span><span>    } </span><span style="color:#ffa759;">else if</span><span> input</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">just_pressed</span><span>(KeyCode</span><span style="color:#f29e74;">::</span><span>Digit4) {
</span><span>        </span><span style="font-style:italic;color:#5c6773;">// Pressing 4 enables stepping again.
</span><span>        stepping</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">enable</span><span>()</span><span style="color:#ccc9c2cc;">;
</span><span>    }
</span><span>}
</span></code></pre>
<p>In combination with gizmos, I start my simulation, run it for some frames until something interesting happens like a collision and then go frame-by-frame to check all vectors, collision points etc.</p>
<p>You might ask, why not use a debugger with break points instead?</p>
<p>The advantage of system stepping is that it only affects the logic that you enable it on, grouped in something called <em>schedule</em>.
Everything else outside of the targeted schedule continues to run normally.
This avoids freezing and allows you to navigate with your camera if the camera navigation logic is in another schedule.
So you can rotate around and zoom into the object that you are inspecting üîçÔ∏è</p>
<p>Comparing with the XPBD implementation in the <a href="https://github.com/Jondolf/avian"><code>bevy_xpbd</code></a> crate by <a href="https://joonaa.dev">Joona Aalto</a> also helped a lot while debugging my implementation.
The crate is now renamed to <em>Avian</em> with a new solver called <em>TGS Soft</em> that I want to try and compare with.
This is also the solver used by <a href="https://rapier.rs/">Rapier</a>, another physics engine in Rust.</p>
<h2 id="ecosystem"><a class="text-white no-underline transition-none hover:underline"
   href="#ecosystem">Ecosystem</a></h2>
<p>There are many crates extending the functionality of Bevy and it is pretty easy to integrate them.
Nevertheless, I tried to keep the amount of dependencies at a minimum to learn more by implementing what I need.
I also didn't want to wait on one more dependency to add support for the latest Bevy release before I am able to migrate (see migrations section later on).</p>
<p>I used the following Bevy plugin crates:</p>
<ul>
<li><a href="https://github.com/mvlabat/bevy_egui"><code>bevy_egui</code></a> which is an integration of <a href="https://www.egui.rs">egui</a> into Bevy. Perfect for live plots of a real-time simulation.</li>
<li><a href="https://github.com/qu1x/bevy_trackball"><code>bevy_trackball</code></a> for camera navigation. It can even handle touch events!</li>
<li><a href="https://github.com/aevyrie/bevy_mod_picking"><code>bevy_mod_picking</code></a> for picking meshes and handling dragging them. This crate is planned to be upstreamed so it should be part of Bevy soon.</li>
</ul>
<h2 id="ecs"><a class="text-white no-underline transition-none hover:underline"
   href="#ecs">ECS</a></h2>
<p>When you use crates in the Bevy ecosystem or even write your own plugins, you feel some kind of magic!
To give you an impression, we need to briefly talk about Bevy's design around <a href="https://en.wikipedia.org/wiki/Entity_component_system"><strong>ECS</strong></a>: <strong>E</strong>ntity <strong>C</strong>omponent <strong>S</strong>ystem.</p>
<p>For a simplified explanation, let's take a ball bouncing on the ground as an example:</p>
<ul>
<li><em>Entities</em> are the objects in the simulated <em>world</em> like the ball. These can have multiple components.</li>
<li><em>Components</em> are data structures that characterize an entity. For example, the ball can have the components <code>Position</code>, <code>Velocity</code> and <code>Mass</code>.</li>
<li><em>Systems</em> are Rust functions that can query components and modify them (similar to a database query).</li>
</ul>
<p>Components are normal Rust structs.
For example, the position can be just a wrapper around <a href="https://docs.rs/glam/0.28.0/glam/f64/struct.DVec3.html"><code>DVec3</code></a> (a 3-dimensional <code>f64</code> vector):</p>
<pre data-lang="rust" style="background-color:#212733;color:#ccc9c2;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#ccc9c2cc;">#</span><span>[</span><span style="color:#ffd580;">derive</span><span>(Component)]
</span><span style="color:#ffa759;">struct </span><span style="color:#73d0ff;">Position</span><span>(DVec3)</span><span style="color:#ccc9c2cc;">;
</span></code></pre>
<p>An example for a system would be a function that integrates the linear velocity and position.
This function works on every entity that contains the components position, velocity and mass:</p>
<pre data-lang="rust" style="background-color:#212733;color:#ccc9c2;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#ffa759;">fn </span><span style="color:#ffd580;">integrate</span><span>(</span><span style="color:#ffa759;">mut </span><span style="color:#ffcc66;">q</span><span style="color:#ccc9c2cc;">: </span><span>Query&lt;</span><span style="color:#f29e74;">&amp;</span><span style="color:#ffa759;">mut</span><span> Position, </span><span style="color:#f29e74;">&amp;</span><span style="color:#ffa759;">mut</span><span> Velocity, </span><span style="color:#f29e74;">&amp;</span><span>Mass&gt;) {
</span><span>    </span><span style="color:#ffa759;">for </span><span>(</span><span style="color:#ffa759;">mut</span><span> r</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffa759;">mut</span><span> v</span><span style="color:#ccc9c2cc;">,</span><span> m) </span><span style="color:#f29e74;">in &amp;</span><span style="color:#ffa759;">mut</span><span> q {
</span><span>        </span><span style="font-style:italic;color:#5c6773;">// ‚Ä¶
</span><span>    }
</span><span>}
</span></code></pre>
<p>You can define such systems to plot the potential, kinetic and rotational energies of the simulation.
Then, you collect the plotting logic in a <a href="https://docs.rs/bevy/latest/bevy/app/trait.Plugin.html"><code>Plugin</code></a>.
Now, if you start with a new simulation and want to plot the energy, it is a matter of adding one line that adds the plotting plugin!
Everything works as expected for every simulation as long as each simulation uses the same components.</p>
<p><img src="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/blog/physics-simulations-in-bevy/energy_plot.png" alt="A screenshot of the energy plot in a simulation of a box bouncing on the ground (with friction)" /></p>
<p>Take a look at the following Git commit.
It imports and adds egui and my energy plotting plugin to a new simulation:</p>
<p><img src="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/blog/physics-simulations-in-bevy/commit.png" alt="Screenshot of a Git commit" /></p>
<p>Yes, it is just a change of 4 lines to add that energy plot to new simulations ü§Ø</p>
<h2 id="simulations"><a class="text-white no-underline transition-none hover:underline"
   href="#simulations">Simulations</a></h2>
<p>The most important simulations that I made are Rattleback and Tippe Top.</p>
<p><strong>Rattleback</strong> (check out the <a href="https://en.wikipedia.org/wiki/Rattleback">Wikipedia article and its video</a>):</p>
<p><img src="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/blog/physics-simulations-in-bevy/rattleback.png" alt="Screenshot of my simulation of a rattleback" /></p>
<p><strong>Tippe Top</strong> (check out the <a href="https://en.wikipedia.org/wiki/Tippe_top">Wikipedia article and its video</a>:</p>
<p><img src="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/blog/physics-simulations-in-bevy/tippe_top.png" alt="Screenshot of my simulation of a tippe top" /></p>
<p>For more details about the simulations, wait until I publish my master's thesis üòâ</p>
<h2 id="migrations"><a class="text-white no-underline transition-none hover:underline"
   href="#migrations">Migrations</a></h2>
<p>Bevy is still under heavy development and there is a new release every 3 months.
This is awesome because you get new features like the mentioned system stepping.
But new versions also have some breaking changes.</p>
<p>Fortunately, these changes are very well documented in Bevy's <a href="https://bevyengine.org/learn/migration-guides">migration guides</a>.
But not only you need to migrate.
You need to wait for all your dependencies to also migrate.
So I recommend to keep the amount of used dependencies at a minimum and wait at least a week before trying to migrate.</p>
<p>This situation has been improved in the latest release of <code>0.14</code> because a release candidate was published before the actual release so that developers of plugins had some time to prepare a release ‚ú®</p>
<h2 id="conclusion"><a class="text-white no-underline transition-none hover:underline"
   href="#conclusion">Conclusion</a></h2>
<p>Is Bevy ready for production?
<em>No</em>.
Bevy itself is transparent about this.
Here is a <a href="https://bevyengine.org/learn/quick-start/introduction">quote from its official website</a>:</p>
<blockquote>
<p>Bevy is still in the early stages of development.
Important features are missing.
Documentation is sparse.
A new version of Bevy containing breaking changes to the API is released approximately once every 3 months.
We provide migration guides, but we can't guarantee migrations will always be easy.
Use only if you are willing to work in this environment.</p>
<p>If you are currently trying to pick an engine for your Next Big Project‚Ñ¢, we recommend that you check out Godot Engine.
It is currently much more feature-complete and stable.
And it is also free, open-source, and scriptable with Rust!</p>
</blockquote>
<p>But I think that Bevy is already a very good fit for small games and scientific/physics simulations!
I really enjoy using it and feel very productive ü•∞</p>
<p>Bevy has a bright future since the <a href="https://bevyengine.org/foundation/">Bevy Foundation</a> was created some months ago and there are paid developers like <a href="https://github.com/alice-i-cecile">Alice Cecile</a> working on it in addition to many enthusiastic open source contributors üöÄ</p>
<p>Finally, unless you are willing to invest some months to get a deep understanding of how physics engines work, I recommend using <a href="https://github.com/Jondolf/avian">Avian</a> instead of writing your physics from scratch üòÖ</p>

    </article>

    
        <nav class="flex flex-col gap-y-3 mt-8">
            
            
    
    <a class="py-1.5 px-3 my-2 no-underline bg-gray-800 rounded-xl transition duration-500 hover:scale-[1.02]"
       href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/blog/rustlings-rewrite/">Previous post: Rustlings Rewrite<hr class="mt-1 mb-3 rounded-none border-gray-600"><span class="text-white">Version 6 of Rustlings is a rewrite providing a ton of features and improvements</span></a>


        </nav>
    

    <section class="mt-8 text-base text-center">
        <p>
            You can suggest improvements on the <a href="https://codeberg.org/mo8it/website/src/branch/main/content/blog">website's repository</a>
        </p>
        <p>
            Content license: <a href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a>
        </p>
    </section>

        </main>

        <footer class="pt-2 pb-3 mt-auto">
            <img class="m-0 mx-auto w-20 h-20"
                 src="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/images/happy_ferris.svg"
                 alt="">

            <nav class="flex flex-col gap-y-3 justify-around py-3 text-center bg-gray-800 rounded sm:flex-row sm:rounded-full">
                
                    <a class="text-sm no-underline" href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/contact">Contact</a>
                
                    <a class="text-sm no-underline" href="https://codeberg.org/salif/mo8it-mod">Source Code</a>
                
                    <a class="text-sm no-underline" href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/legal-notice">Legal Notice</a>
                
                    <a class="text-sm no-underline" href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/privacy-policy">Privacy Policy</a>
                
            </nav>
        </footer>

        
            <script type="module" src="https://oxitraffic.mo8it.com/count.js"></script>
        
    </body>
</html>
