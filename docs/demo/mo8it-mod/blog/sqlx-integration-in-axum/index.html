<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <title>SQLx integration in Axum</title>

        <meta name="description"
              content="How to integrate SQLx in an Axum backend to interact with a database">
        <link rel="icon"
              type="image/x-icon"
              href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/images/logo.svg?h=317a88501f91157f0cdc">

        <link href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/main.css?h=f85c3d699fb7dbadce40"
              rel="stylesheet">

        <link rel="alternate"
              type="application/atom+xml"
              title="Blog"
              href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/atom.xml">

        <meta property="og:title" content="SQLx integration in Axum">
        <meta property="og:description" content="How to integrate SQLx in an Axum backend to interact with a database">
        <meta property="og:image"
              content="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/images/logo.svg?h=317a88501f91157f0cdc">
        <meta property="og:url" content="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/blog/sqlx-integration-in-axum/">
    </head>

    <body class="flex flex-col p-3 mx-auto min-h-screen text-lg text-gray-100 break-words bg-gray-900 lg:px-5 2xl:container">
        <header class="flex gap-x-6 items-center py-2 px-2.5 mb-1 bg-gray-800 rounded-full">
            <a class="transition duration-500 hover:scale-110"
               href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod"
               aria-hidden="true">
                <img class="m-0 w-12 h-12 rounded-full"
                     src="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/images/logo.svg"
                     alt="">
            </a>
            <nav class="flex gap-x-5 items-center font-bold">
                
                    <a class="p-1 no-underline" href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/">Home</a>
                
                    <a class="p-1 no-underline" href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/blog">Blog</a>
                
                    <a class="p-1 no-underline" href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/tags">Tags</a>
                
            </nav>
        </header>

        <main class="leading-relaxed">
            
    <article>
        <div class="mb-3">
            <h1>SQLx integration in Axum</h1>

            
    <div class="mt-2 mb-4 text-sm leading-normal text-gray-300">
        <time datetime="2023-05-29">2023-05-29</time><p class="my-0">
            Tags:
            <a href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/tags/rust">#rust</a><span class="pr-1.5">,</span><a href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/tags/axum">#axum</a><span class="pr-1.5">,</span><a href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/tags/web">#web</a><span class="pr-1.5">,</span><a href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/tags/database">#database</a></p>

        <p class="my-0">Reading time: ~7min</p>

        <hr class="my-2.5">
    </div>

        </div>

        <p>SQLx is an awesome crate for interacting with databases in Rust with compile time checks.
In this blog post, we will learn how to use it in an Axum backend to store and retrieve data from a database.</p>
<p>The example will be storing submitted contact forms from the <a href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/blog/getting-started-with-rust-backends/">previous post about Axum</a>.</p>
<p>During the SQLx integration, we will learn about states and returning JSON in Axum.</p>
<span id="continue-reading"></span><div class="rounded-xl bg-yellow-400/20">
    <div class="px-2 pt-2 pb-1 my-3 text-white">
        <p class="font-bold">‚ö†Ô∏è Warning ‚ö†Ô∏è</p>
        <p>This blog post builds on the <a href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/blog/getting-started-with-rust-backends/">post about Axum</a> and the <a href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/blog/sqlx-interacting-with-databases-in-rust/">post about SQLx</a>. <strong>Read both of them first before continuing!</strong> ü§ì</p>

    </div>
</div>

    <p class="p-1 my-4 text-base rounded sm:hidden bg-yellow-200/20">Landscape mode recommended on mobile devices</p>

    
        <div class="px-4 pt-3 pb-0.5 mt-3 mb-1 bg-gray-800 rounded">
            <p class="text-2xl font-bold">Contents</p>

            <nav>
                <ul class="ml-0 list-none">
                    
                        
                    
                        
                            <li><a href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/blog/sqlx-integration-in-axum/#base-project">Base project</a></li>
                        
                    
                        
                            <li><a href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/blog/sqlx-integration-in-axum/#sqlx-preparation">SQLx preparation</a></li>
                        
                    
                        
                            <li><a href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/blog/sqlx-integration-in-axum/#dependencies">Dependencies</a>
                                    <ul class="my-0 ml-5 list-none">
                                        
                                            
                                                <li><a class="text-base" href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/blog/sqlx-integration-in-axum/#imports">Imports</a></li>
                                            
                                        
                                    </ul>
                                </li>
                        
                    
                        
                            <li><a href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/blog/sqlx-integration-in-axum/#states">States</a></li>
                        
                    
                        
                            <li><a href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/blog/sqlx-integration-in-axum/#inserting-into-the-database">Inserting into the database</a></li>
                        
                    
                        
                            <li><a href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/blog/sqlx-integration-in-axum/#reading-from-the-database">Reading from the database</a></li>
                        
                    
                        
                            <li><a href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/blog/sqlx-integration-in-axum/#summary">Summary</a>
                                    <ul class="my-0 ml-5 list-none">
                                        
                                            
                                        
                                    </ul>
                                </li>
                        
                    
                </ul>
            </nav>
        </div>
    

<h4 id="disclaimer"><a class="text-white no-underline transition-none hover:underline"
   href="#disclaimer">Disclaimer</a></h4>
<p>This post is not about SQL. Therefore, the details of SQL statements will not be explained.</p>
<p>The post uses <code>unwrap</code> and <code>expect</code> to focus on the main concepts.
In a real project, you should do <strong>proper error handling!</strong></p>
<p>I will assume that you are familiar with the first few chapters of <a href="https://doc.rust-lang.org/stable/book">the Rust book</a> and know the basics of async Rust with <code>tokio</code>.</p>
<h2 id="base-project"><a class="text-white no-underline transition-none hover:underline"
   href="#base-project">Base project</a></h2>
<p>The example extends the small Axum backend built in the <a href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/blog/getting-started-with-rust-backends/">blog post about Axum</a>.
Use the <a href="https://codeberg.org/mo8it/blog_demos/src/branch/main/getting-started-with-rust-backends"><strong>code of that post</strong></a> as a starting point.</p>
<p>You can clone the whole repository and start extending in the <code>getting-started-with-rust-backends</code> directory.</p>
<h2 id="sqlx-preparation"><a class="text-white no-underline transition-none hover:underline"
   href="#sqlx-preparation">SQLx preparation</a></h2>
<p><strong>The steps in this section are analogous to the <a href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/blog/sqlx-interacting-with-databases-in-rust/">blog post about SQLx</a> where they are explained properly.</strong></p>
<p>First, run a PostgreSQL database <code>postgres</code> at the host <code>127.0.0.1</code> (localhost) on port <code>5432</code> with the username <code>postgres</code> and the password <code>CHANGE_ME</code>.</p>
<p>Now, tell SQLx how to connect to the database by storing the following environment variable in the file <code>.env</code>:</p>
<pre style="background-color:#212733;color:#ccc9c2;"><code><span>DATABASE_URL=postgresql://postgres:CHANGE_ME@127.0.0.1:5432/postgres
</span></code></pre>
<p>Now, let's make sure that we can connect to the database and that it is created using the SQLx-CLI:</p>
<pre data-lang="fish" style="background-color:#212733;color:#ccc9c2;" class="language-fish "><code class="language-fish" data-lang="fish"><span style="color:#ffd580;">sqlx </span><span>database create
</span></code></pre>
<p>If the previous command returns any error, check your database connection before continuing!</p>
<p>We want to create a table in the database that contains the content of our contact form:</p>
<ul>
<li>Non-optional name</li>
<li>Non-optional email</li>
<li>Non-optional message</li>
</ul>
<p>The fields being non-optional means that they can't be <code>NULL</code> in the database.</p>
<p>Let's create such a table named <code>submissions</code>.</p>
<p>First, create the first migration:</p>
<pre data-lang="fish" style="background-color:#212733;color:#ccc9c2;" class="language-fish "><code class="language-fish" data-lang="fish"><span style="color:#ffd580;">sqlx </span><span>migrate add create_submissions_table
</span></code></pre>
<p>The previous command creates the new file <code>TIMESTAMP_create_submissions_table.sql</code> where TIMESTAMP is the Unix timestamp of the migration.
Place the following SQL statement in the created SQL file:</p>
<pre data-lang="sql" style="background-color:#212733;color:#ccc9c2;" class="language-sql "><code class="language-sql" data-lang="sql"><span style="color:#ffa759;">CREATE TABLE </span><span>IF NOT EXISTS </span><span style="color:#ffd580;">submissions</span><span> (
</span><span>    id </span><span style="color:#ffa759;">BIGSERIAL PRIMARY KEY</span><span>,
</span><span>    name </span><span style="color:#ffa759;">TEXT </span><span style="color:#f29e74;">NOT </span><span style="color:#ffcc66;">NULL</span><span>,
</span><span>    email </span><span style="color:#ffa759;">TEXT </span><span style="color:#f29e74;">NOT </span><span style="color:#ffcc66;">NULL</span><span>,
</span><span>    message </span><span style="color:#ffa759;">TEXT </span><span style="color:#f29e74;">NOT </span><span style="color:#ffcc66;">NULL
</span><span>);
</span></code></pre>
<p>The <code>id</code> having the type <code>BIGSERIAL</code> means that it will be automatically incremented so we don't have to specify it when inserting to the table.</p>
<p>Run the migration using the following command:</p>
<pre data-lang="fish" style="background-color:#212733;color:#ccc9c2;" class="language-fish "><code class="language-fish" data-lang="fish"><span style="color:#ffd580;">sqlx </span><span>migrate run
</span></code></pre>
<p>Finally let's run the following command to trigger recompilation after adding possible later migrations:</p>
<pre data-lang="fish" style="background-color:#212733;color:#ccc9c2;" class="language-fish "><code class="language-fish" data-lang="fish"><span style="color:#ffd580;">sqlx </span><span>migrate build-script
</span></code></pre>
<p>The SQLx preparation is done üéâ We can start coding now ü¶Ä</p>
<h2 id="dependencies"><a class="text-white no-underline transition-none hover:underline"
   href="#dependencies">Dependencies</a></h2>
<p>To follow the example, add the following additional dependencies to <code>Cargo.toml</code> of the base project:</p>
<pre data-lang="toml" style="background-color:#212733;color:#ccc9c2;" class="language-toml "><code class="language-toml" data-lang="toml"><span>[</span><span style="color:#73d0ff;">dependencies</span><span>]
</span><span style="color:#73d0ff;">dotenvy </span><span>= </span><span style="color:#bae67e;">&quot;0.15.7&quot;
</span><span style="color:#73d0ff;">sqlx </span><span>= { </span><span style="color:#73d0ff;">version </span><span>= </span><span style="color:#bae67e;">&quot;0.6.3&quot;</span><span style="color:#ccc9c2cc;">, </span><span style="color:#73d0ff;">features </span><span>= [</span><span style="color:#bae67e;">&quot;postgres&quot;</span><span style="color:#ccc9c2cc;">, </span><span style="color:#bae67e;">&quot;macros&quot;</span><span style="color:#ccc9c2cc;">, </span><span style="color:#bae67e;">&quot;runtime-tokio-rustls&quot;</span><span>] }
</span></code></pre>
<h3 id="imports"><a class="text-white no-underline transition-none hover:underline"
   href="#imports">Imports</a></h3>
<p>All additional imports used in the example are gathered below to keep later code snippets slim:</p>
<pre data-lang="rust" style="background-color:#212733;color:#ccc9c2;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#ffa759;">use </span><span>axum</span><span style="color:#f29e74;">::</span><span>{extract</span><span style="color:#f29e74;">::</span><span>State</span><span style="color:#ccc9c2cc;">,</span><span> Json}</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">use </span><span>serde</span><span style="color:#f29e74;">::</span><span>Serialize</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">use </span><span>sqlx</span><span style="color:#f29e74;">::</span><span>{postgres</span><span style="color:#f29e74;">::</span><span>PgPoolOptions</span><span style="color:#ccc9c2cc;">,</span><span> PgPool}</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">use </span><span>std</span><span style="color:#f29e74;">::</span><span>{env</span><span style="color:#ccc9c2cc;">, </span><span>sync</span><span style="color:#f29e74;">::</span><span>Arc}</span><span style="color:#ccc9c2cc;">;
</span></code></pre>
<h2 id="states"><a class="text-white no-underline transition-none hover:underline"
   href="#states">States</a></h2>
<p>How do we want to integrate SQLx into our base project?</p>
<p>The naive idea would be to create a new database connection inside each handler.
But this would be very inefficient since creating a database connection is expensive!</p>
<p>Instead, we should create a connection pool and share it with all handlers!
But how can we make such a pool accessible by all handlers?
Do we need something like global variables?
Fortunately, no!</p>
<p>Axum provides <a href="https://docs.rs/axum/0.6.18/axum/extract/struct.State.html">states</a> for sharing across handlers.</p>
<p>A state is a struct that implements <code>Clone</code>.
It has to implement <code>Clone</code> because Axum clones it for every handler call.</p>
<p>The state that we want to create is a struct containing one field which is the connection pool:</p>
<pre data-lang="rust" style="background-color:#212733;color:#ccc9c2;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#ffa759;">struct </span><span style="color:#73d0ff;">AppStateInner </span><span>{
</span><span>    pool</span><span style="color:#ccc9c2cc;">:</span><span> PgPool,
</span><span>}
</span></code></pre>
<p>Let's define a constructor for our struct:</p>
<pre data-lang="rust" style="background-color:#212733;color:#ccc9c2;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#ffa759;">impl </span><span style="color:#73d0ff;">AppStateInner </span><span>{
</span><span>    async </span><span style="color:#ffa759;">fn </span><span style="color:#ffd580;">new</span><span>() </span><span style="color:#ccc9c2cc;">-&gt; </span><span style="color:#ffa759;">Self </span><span>{
</span><span>        dotenvy</span><span style="color:#f29e74;">::</span><span>dotenv()</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">expect</span><span>(</span><span style="color:#bae67e;">&quot;Could not load the .env file!&quot;</span><span>)</span><span style="color:#ccc9c2cc;">;
</span><span>        </span><span style="color:#ffa759;">let</span><span> database_url </span><span style="color:#f29e74;">=
</span><span>            env</span><span style="color:#f29e74;">::</span><span>var(</span><span style="color:#bae67e;">&quot;DATABASE_URL&quot;</span><span>)</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">expect</span><span>(</span><span style="color:#bae67e;">&quot;The environment variable DATABASE_URL is missing!&quot;</span><span>)</span><span style="color:#ccc9c2cc;">;
</span><span>
</span><span>        </span><span style="color:#ffa759;">let</span><span> pool </span><span style="color:#f29e74;">= </span><span>PgPoolOptions</span><span style="color:#f29e74;">::</span><span>new()
</span><span>            </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">connect</span><span>(</span><span style="color:#f29e74;">&amp;</span><span>database_url)
</span><span>            </span><span style="color:#f29e74;">.</span><span>await
</span><span>            </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">expect</span><span>(</span><span style="color:#bae67e;">&quot;Failed to connect to the database!&quot;</span><span>)</span><span style="color:#ccc9c2cc;">;
</span><span>
</span><span>        </span><span style="color:#ffa759;">Self </span><span>{ pool }
</span><span>    }
</span><span>}
</span></code></pre>
<p>The constructor adds the variable <code>DATABASE_URL</code> from the <code>.env</code> file to the environment variables and creates the pool as described in the <a href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/blog/sqlx-interacting-with-databases-in-rust/">post about SQLx</a>.</p>
<p>Our state is almost ready...</p>
<p>Did you ask yourself why the struct is called <code>AppStateInner</code>? ü§î</p>
<p>We have said that a state has to implement <code>Clone</code>, but our struct does not implement it yet!</p>
<p>In general, we have to wrap our struct with an <a href="https://doc.rust-lang.org/stable/std/sync/struct.Arc.html"><code>Arc</code></a> for atomic reference counting.
Cloning an <code>Arc</code> of a struct is like cloning a pointer to the struct and incrementing the atomic reference counter by one.</p>
<p>To wrap our struct with an <code>Arc</code>, we define the type alias <code>AppState</code>:</p>
<pre data-lang="rust" style="background-color:#212733;color:#ccc9c2;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#ffa759;">type </span><span style="color:#73d0ff;">AppState </span><span style="color:#f29e74;">= </span><span>Arc&lt;AppStateInner&gt;</span><span style="color:#ccc9c2cc;">;
</span></code></pre>
<div class="rounded-xl bg-sky-400/20">
    <div class="px-2 pt-2 pb-1 my-3 text-white">
        <p class="font-bold">Note</p>
        <p>In this particular case, we could have derived <code>Clone</code> for our struct since <a href="https://docs.rs/sqlx/0.6.3/sqlx/struct.Pool.html">a SQLx connection pool is itself a wrapper around an <code>Arc</code></a>.
We could also have directly used the pool as a state without the struct <code>AppStateInner</code>.</p>
<p>But I wanted to show the general way of working with states.
The idea of the struct is that it can contain multiple fields.
If we want to share something else later in addition to the pool, we can just add it to the struct <code>AppStateInner</code> without worrying about if it implements Clone in a correct way for sharing or not.</p>

    </div>
</div>
<p>Now, in our <code>main</code> function, we initialize the state and provide it for the handlers using the method <code>with_state</code>:</p>
<pre data-lang="rust" style="background-color:#212733;color:#ccc9c2;" class="language-rust "><code class="language-rust" data-lang="rust"><mark style="background-color:#1c222c;"><span style="color:#ffa759;">let</span><span> state </span><span style="color:#f29e74;">= </span><span>Arc</span><span style="color:#f29e74;">::</span><span>new(AppStateInner</span><span style="color:#f29e74;">::</span><span>new()</span><span style="color:#f29e74;">.</span><span>await)</span><span style="color:#ccc9c2cc;">;
</span></mark><span>
</span><span style="color:#ffa759;">let</span><span> router </span><span style="color:#f29e74;">= </span><span>Router</span><span style="color:#f29e74;">::</span><span>new()
</span><span>    </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">route</span><span>(</span><span style="color:#bae67e;">&quot;/&quot;</span><span style="color:#ccc9c2cc;">, </span><span style="color:#f28779;">get</span><span>(index))
</span><span>    </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">route</span><span>(</span><span style="color:#bae67e;">&quot;/submit&quot;</span><span style="color:#ccc9c2cc;">, </span><span style="color:#f28779;">post</span><span>(submit))
</span><mark style="background-color:#1c222c;"><span>    </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">with_state</span><span>(state)</span><span style="color:#ccc9c2cc;">;
</span></mark></code></pre>
<p>To receive the state in the <code>submit</code> handler, we change its signature to the following by adding the state as <code>State&lt;AppState&gt;</code>:</p>
<pre data-lang="rust" style="background-color:#212733;color:#ccc9c2;" class="language-rust "><code class="language-rust" data-lang="rust"><span>async </span><span style="color:#ffa759;">fn </span><span style="color:#ffd580;">submit</span><span>(</span><span style="color:#ffcc66;">state</span><span style="color:#ccc9c2cc;">: </span><span>State&lt;AppState&gt;, </span><span style="color:#ffcc66;">fields</span><span style="color:#ccc9c2cc;">: </span><span>Form&lt;FormFields&gt;) </span><span style="color:#ccc9c2cc;">-&gt;</span><span> Response
</span></code></pre>
<p>The type <code>State</code> is an Axum extractor that extracts a state if it was provided to the router of this handler (checked at compile time).</p>
<div class="rounded-xl bg-sky-400/20">
    <div class="px-2 pt-2 pb-1 my-3 text-white">
        <p class="font-bold">Note</p>
        <p>Not all handlers of a router with a state have to use the state or even include it in their signature.
The handler <code>index</code> in our example stays untouched.</p>

    </div>
</div>
<h2 id="inserting-into-the-database"><a class="text-white no-underline transition-none hover:underline"
   href="#inserting-into-the-database">Inserting into the database</a></h2>
<p>We want to insert a form submission into the database in the <code>submit</code> handler. In this handler, we receive the submission as a <code>Form</code> with fields in the following struct:</p>
<pre data-lang="rust" style="background-color:#212733;color:#ccc9c2;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#ffa759;">struct </span><span style="color:#73d0ff;">FormFields </span><span>{
</span><span>    name</span><span style="color:#ccc9c2cc;">:</span><span> String,
</span><span>    email</span><span style="color:#ccc9c2cc;">:</span><span> String,
</span><span>    message</span><span style="color:#ccc9c2cc;">:</span><span> String,
</span><span>}
</span></code></pre>
<p>We want to implement a function for this struct that takes a reference to the connection pool and inserts the fields as a row in the <code>submissions</code> table:</p>
<pre data-lang="rust" style="background-color:#212733;color:#ccc9c2;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#ffa759;">impl </span><span style="color:#73d0ff;">FormFields </span><span>{
</span><span>    async </span><span style="color:#ffa759;">fn </span><span style="color:#ffd580;">insert_into_db</span><span>(</span><span style="color:#f29e74;">&amp;</span><span style="color:#ffcc66;">self</span><span>, </span><span style="color:#ffcc66;">pool</span><span style="color:#ccc9c2cc;">: </span><span style="color:#f29e74;">&amp;</span><span>PgPool) {
</span><span>        sqlx</span><span style="color:#f29e74;">::</span><span>query</span><span style="color:#f29e74;">!</span><span>(
</span><span>            </span><span style="color:#bae67e;">&quot;INSERT INTO submissions(name, email, message) VALUES ($1, $2, $3)&quot;</span><span style="color:#ccc9c2cc;">,
</span><span>            </span><span style="color:#f29e74;">&amp;</span><span style="font-style:italic;color:#5ccfe6;">self</span><span style="color:#f29e74;">.</span><span>name</span><span style="color:#ccc9c2cc;">,
</span><span>            </span><span style="color:#f29e74;">&amp;</span><span style="font-style:italic;color:#5ccfe6;">self</span><span style="color:#f29e74;">.</span><span>email</span><span style="color:#ccc9c2cc;">,
</span><span>            </span><span style="color:#f29e74;">&amp;</span><span style="font-style:italic;color:#5ccfe6;">self</span><span style="color:#f29e74;">.</span><span>message
</span><span>        )
</span><span>        </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">execute</span><span>(pool)
</span><span>        </span><span style="color:#f29e74;">.</span><span>await
</span><span>        </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">expect</span><span>(</span><span style="color:#bae67e;">&quot;Failed to insert a submission into the database!&quot;</span><span>)</span><span style="color:#ccc9c2cc;">;
</span><span>
</span><span>        </span><span style="color:#f28779;">println!</span><span>(</span><span style="color:#bae67e;">&quot;Inserted a submission into the database!&quot;</span><span>)</span><span style="color:#ccc9c2cc;">;
</span><span>    }
</span><span>}
</span></code></pre>
<p>If the insertion was successful, a message is printed out.</p>
<p>Now, let's use this function in the <code>submit</code> handler! Replace the <code>pritnln</code> expression that prints out the form fields in the handler with the following:</p>
<pre data-lang="rust" style="background-color:#212733;color:#ccc9c2;" class="language-rust "><code class="language-rust" data-lang="rust"><span>fields</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">insert_into_db</span><span>(</span><span style="color:#f29e74;">&amp;</span><span>state</span><span style="color:#f29e74;">.</span><span>pool)</span><span style="color:#f29e74;">.</span><span>await</span><span style="color:#ccc9c2cc;">;
</span></code></pre>
<p>Run the program, visit <code>127.0.0.1:8080</code> and submit a form. If you see "Inserted a submission into the database!" printed out in the terminal, then congratulations, you did successfully run your first SQLx query in Axum üéâ</p>
<h2 id="reading-from-the-database"><a class="text-white no-underline transition-none hover:underline"
   href="#reading-from-the-database">Reading from the database</a></h2>
<p>How can we see the submissions in the database?</p>
<p>Let's add a handler that returns the list of all submissions as JSON (in an API style).</p>
<p>First, we need a function that returns the list of submissions from the database. Add the following function to the implementation of <code>FormFields</code>:</p>
<pre data-lang="rust" style="background-color:#212733;color:#ccc9c2;" class="language-rust "><code class="language-rust" data-lang="rust"><span>async </span><span style="color:#ffa759;">fn </span><span style="color:#ffd580;">get_all_submissions</span><span>(</span><span style="color:#ffcc66;">pool</span><span style="color:#ccc9c2cc;">: </span><span style="color:#f29e74;">&amp;</span><span>PgPool) </span><span style="color:#ccc9c2cc;">-&gt; </span><span style="font-style:italic;color:#5ccfe6;">Vec</span><span>&lt;</span><span style="color:#ffa759;">Self</span><span>&gt; {
</span><span>    sqlx</span><span style="color:#f29e74;">::</span><span>query_as</span><span style="color:#f29e74;">!</span><span>(</span><span style="color:#ffa759;">Self</span><span style="color:#ccc9c2cc;">, </span><span style="color:#bae67e;">&quot;SELECT name, email, message FROM submissions&quot;</span><span>)
</span><span>        </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">fetch_all</span><span>(pool)
</span><span>        </span><span style="color:#f29e74;">.</span><span>await
</span><span>        </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">expect</span><span>(</span><span style="color:#bae67e;">&quot;Failed to get submissions from the database!&quot;</span><span>)
</span><span>}
</span></code></pre>
<p>It takes a reference to a connection pool and runs a query. The output is a vector of <code>FormFields</code>.</p>
<p>To use this function in a handler, add the route "/all-submissions" first:</p>
<pre data-lang="rust" style="background-color:#212733;color:#ccc9c2;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#ffa759;">let</span><span> router </span><span style="color:#f29e74;">= </span><span>Router</span><span style="color:#f29e74;">::</span><span>new()
</span><span>    </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">route</span><span>(</span><span style="color:#bae67e;">&quot;/&quot;</span><span style="color:#ccc9c2cc;">, </span><span style="color:#f28779;">get</span><span>(index))
</span><span>    </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">route</span><span>(</span><span style="color:#bae67e;">&quot;/submit&quot;</span><span style="color:#ccc9c2cc;">, </span><span style="color:#f28779;">post</span><span>(submit))
</span><mark style="background-color:#1c222c;"><span>    </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">route</span><span>(</span><span style="color:#bae67e;">&quot;/all-submissions&quot;</span><span style="color:#ccc9c2cc;">, </span><span style="color:#f28779;">get</span><span>(all_submissions))
</span></mark><span>    </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">with_state</span><span>(state)</span><span style="color:#ccc9c2cc;">;
</span></code></pre>
<p>Now, implement the handler <code>all_submissions</code>:</p>
<pre data-lang="rust" style="background-color:#212733;color:#ccc9c2;" class="language-rust "><code class="language-rust" data-lang="rust"><span>async </span><span style="color:#ffa759;">fn </span><span style="color:#ffd580;">all_submissions</span><span>(</span><span style="color:#ffcc66;">state</span><span style="color:#ccc9c2cc;">: </span><span>State&lt;AppState&gt;) </span><span style="color:#ccc9c2cc;">-&gt; </span><span>Json&lt;</span><span style="font-style:italic;color:#5ccfe6;">Vec</span><span>&lt;FormFields&gt;&gt; {
</span><span>    Json(FormFields</span><span style="color:#f29e74;">::</span><span>get_all_submissions(</span><span style="color:#f29e74;">&amp;</span><span>state</span><span style="color:#f29e74;">.</span><span>pool)</span><span style="color:#f29e74;">.</span><span>await)
</span><span>}
</span></code></pre>
<p>But for returning a struct as JSON, the struct has to implement <code>Serialize</code>.</p>
<p><code>Vec&lt;T&gt;</code> implements <code>Serialize</code> if <code>T</code> implements <code>Serialize</code>. Therefore, we have to derive <code>Serialize</code> for our struct (in addition to <code>Deserialize</code> which is needed for the <code>Form</code> extractor):</p>
<pre data-lang="rust" style="background-color:#212733;color:#ccc9c2;" class="language-rust "><code class="language-rust" data-lang="rust"><mark style="background-color:#1c222c;"><span style="color:#ccc9c2cc;">#</span><span>[</span><span style="color:#ffd580;">derive</span><span>(Deserialize</span><span style="color:#ccc9c2cc;">,</span><span> Serialize)]
</span></mark><span style="color:#ffa759;">struct </span><span style="color:#73d0ff;">FormFields </span><span>{
</span><span>    ...
</span><span>}
</span></code></pre>
<p>Run the program and visit the URL <code>127.0.0.1:8080/all-submissions</code> to see the JSON list of your submissions ü§©</p>
<p>The output will look like the following:</p>
<pre data-lang="json" style="background-color:#212733;color:#ccc9c2;" class="language-json "><code class="language-json" data-lang="json"><span>[
</span><span>  {
</span><span>    </span><span style="color:#bae67e;">&quot;name&quot;</span><span style="color:#ccc9c2cc;">: </span><span style="color:#bae67e;">&quot;Ferris&quot;</span><span style="color:#ccc9c2cc;">,
</span><span>    </span><span style="color:#bae67e;">&quot;email&quot;</span><span style="color:#ccc9c2cc;">: </span><span style="color:#bae67e;">&quot;ferris@rust-lang.org&quot;</span><span style="color:#ccc9c2cc;">,
</span><span>    </span><span style="color:#bae67e;">&quot;message&quot;</span><span style="color:#ccc9c2cc;">: </span><span style="color:#bae67e;">&quot;Are we web yet?&quot;
</span><span>  }</span><span style="color:#ccc9c2cc;">,
</span><span>  {
</span><span>    </span><span style="color:#bae67e;">&quot;name&quot;</span><span style="color:#ccc9c2cc;">: </span><span style="color:#bae67e;">&quot;Mo&quot;</span><span style="color:#ccc9c2cc;">,
</span><span>    </span><span style="color:#bae67e;">&quot;email&quot;</span><span style="color:#ccc9c2cc;">: </span><span style="color:#bae67e;">&quot;example@example.com&quot;</span><span style="color:#ccc9c2cc;">,
</span><span>    </span><span style="color:#bae67e;">&quot;message&quot;</span><span style="color:#ccc9c2cc;">: </span><span style="color:#bae67e;">&quot;Any feedback for this blog post? :D&quot;
</span><span>  }
</span><span>]
</span></code></pre>
<div class="rounded-xl bg-yellow-400/20">
    <div class="px-2 pt-2 pb-1 my-3 text-white">
        <p class="font-bold">‚ö†Ô∏è Warning ‚ö†Ô∏è</p>
        <p>Obviously, you would have to secure such an API behind some authentication mechanism!</p>

    </div>
</div>
<h2 id="summary"><a class="text-white no-underline transition-none hover:underline"
   href="#summary">Summary</a></h2>
<p>Axum + SQLx = üöÄ</p>
<p>Let's dominate web backends with Rust, what are you waiting for? ü§ì</p>
<hr />
<h4 id="full-code"><a class="text-white no-underline transition-none hover:underline"
   href="#full-code">Full code</a></h4>
<p>The full code used in this post can be found <a href="https://codeberg.org/mo8it/blog_demos/src/branch/main/sqlx-integration-in-axum">here</a>.</p>

    </article>

    
        <nav class="flex flex-col gap-y-3 mt-8">
            
    
    <a class="py-1.5 px-3 my-2 no-underline bg-gray-800 rounded-xl transition duration-500 hover:scale-[1.02]"
       href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/blog/rust-vs-julia/">Next post: Rust vs Julia in scientific computing<hr class="mt-1 mb-3 rounded-none border-gray-600"><span class="text-white">Does Julia solve the two-language problem and when should you use Rust instead?</span></a>


            
    
    <a class="py-1.5 px-3 my-2 no-underline bg-gray-800 rounded-xl transition duration-500 hover:scale-[1.02]"
       href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/blog/sqlx-interacting-with-databases-in-rust/">Previous post: SQLx - Interacting with databases in Rust<hr class="mt-1 mb-3 rounded-none border-gray-600"><span class="text-white">How to interact with databases in Rust with SQLx</span></a>


        </nav>
    
    <section class="mt-8 text-base text-center">
        <p>
            You can suggest improvements on the <a href="https://codeberg.org/salif/mo8it-mod/src/branch/main/content/blog">website's repository</a>
        </p>
        <p>
            Content license: <a href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a>
        </p>
    </section>

        </main>

        <footer class="pt-2 pb-3 mt-auto">
            <img class="m-0 mx-auto w-20 h-20"
                 src="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/images/happy_ferris.svg"
                 alt="">
            <nav class="flex flex-col gap-y-3 justify-around py-3 text-center bg-gray-800 rounded sm:flex-row sm:rounded-full">
                
                    <a class="text-sm no-underline" href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/contact">Contact</a>
                
                    <a class="text-sm no-underline" href="https://codeberg.org/salif/mo8it-mod">Source Code</a>
                
                    <a class="text-sm no-underline" href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/legal-notice">Legal Notice</a>
                
                    <a class="text-sm no-underline" href="https://salif.github.io/zola-themes-collection/demo/mo8it-mod/privacy-policy">Privacy Policy</a>
                
            </nav>
        </footer>
                <script async data-goatcounter="https://sgi.goatcounter.com/count"
                    src="//gc.zgo.at/count.js"></script>
    </body>
</html>
